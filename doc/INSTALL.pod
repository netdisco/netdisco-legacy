=head1 NAME

Netdisco INSTALL -- Instructions for setting up Netdisco application.

=head1 AUTHOR

Max Baker C<max@warped.org>

=head1 SUPPORT

Netdisco is hosted by Source Forge.

Please use the C<netdisco-users> mailing list for all problems and comments.

L<http://lists.sourceforge.net/lists/listinfo/netdisco-users>

Please use the Bug interface from Source Forge page at :

L<http://sourceforge.net/projects/netdisco>

Thanks to Mike Hunter at UCB for proofing this document.

=head1 REQUIREMENTS

Netdisco is built using lots of fine Open-Source tools: 

=over

=item * Perl

5.6.1 and newer advised

=item * Perl Modules

Listed below

=item * Net-SNMP

5.0.2 and newer advised

=item * PostgreSQL

Developed under version 7.3

=item * Mason

1.16 or newer required

=item * Apache

1.3.x advised, Version 2.x not supported by mod_perl.

=item * mod_perl   

Version to match Apache

=item * GraphViz

=back

See I<INSTALL> below for details on how to retrieve and install each one.

=head2 OS

Netdisco was developed on a BSD system but should work on any
system that Postgres, Perl, Apache, and Net-SNMP run on.  Linux
is a sure bet. Windows will take a little bit of massaging but
should be possible.

=head1 INSTALL

This is not a terribly easy install.  If you aren't comfortable 
installing programs from source and using a text editor, get some help.  Hopefully
this will all be rolled up into an install script by the time Netdisco comes out of Beta.

=head2 1. Download and Un-archive Netdisco

Get the newest version from L<http://www.netdisco.org>.

    tar xvfz netdisco-x.xx.tar.gz    

Create a directory for Netdisco 

    mkdir /usr/local/netdisco

Move files to that dir

    mv netdisco-x.xx/* /usr/local/netdisco

=head2 2. Create a Unix User/Group for Netdisco  

Create a user and group named C<netdisco>

Give this user permission to the files:

    chown -R netdisco.netdisco /usr/local/netdisco

=head2 3. Add Unix Administrators to Netdisco Group

Once Netdisco is up and running most administration
can be done from the Web interface.  Whoever will be doing
the back-end administration will need to have write access and will need
write access on Netdisco's files.

Add the unix account names of administrators that will modify the 
source code or use the command line interface interface to the C<netdisco>
group in F</etc/groups>.

=head2 4. PostgreSQL

Netdisco's settings in PostgreSQL are

 Database User    : netdisco
 Database Name    : netdisco
 Database Password: you choose it


Follow these steps to setup Netdisco in PostgreSQL.

=over 

=item i. Create Database.

As root or the database user F<pgsql> run C<sql/pg_init> to create 
the database and user for Netdisco.  The password you will be asked
for twice is the new password for the database user you are creating. 
This is the same password you will be putting in F<netdisco_apache.conf>
and in F<netdisco.conf>.

    cd /usr/local/netdisco
    sql/pg_init

=item ii. Check Settings

Now as a non-privileged user make sure you can get into the database by running 
C<sql/pg_run>.  Enter the database user password given above. 

    cd /usr/local/netdisco
    sql/pg_run

=item iii. Create Tables

Once you are sure the database is setup correctly, create the database 
tables with C<sql/pg_all>.  Type in the database user password once 
when prompted.

    cd /usr/local/netdisco
    sql/pg_all

=item iv. Permissions

[Optional] If you have just setup Postgres for the first time you may want to change the
default permissions in F<$PG_DATA/pg_hba.conf> . 

TODO: More here Later

=item v. Optimizations

[Optional] If you have freshly installed Postgresql then the default memory usage should
probably be increased for efficiency.  See the PostgreSQL documentation for 
F<postgresql.conf>.

=back


=head2 5. Perl Modules and Mason

Below is a list of required modules for Netdisco, freely available from
CPAN (http://www.cpan.org).   Many of these modules have prerequisite 
modules.   

Use the CPAN module that comes with Perl to install the modules
and their prerequisites automatically:

    perl -MCPAN -e shell

=over 4

=item install DBI

=item install Apache::DBI

=item install DBD::Pg

=item install Apache::Session

=item install Apache::Request

=item install HTML::Mason

=item install MasonX::Request::WithApacheSession

=item install Graph

=item install GraphViz (optional)

=item install Digest::MD5 (should be built in to perl)

=back

Some of these you will probably already have installed.

=head3 Perl Location

If you have Perl installed in C</usr/bin>, make sure that F<netdisco> and F<bin/doc_munge>
have the correct location for Perl listed at the very top of the file.

=head2 6. Net-SNMP

For BSD install Net SNMP with ports :

    cd /usr/ports/net/net-snmp && make install

For Linux and the rest of the world :

=over

=item i. Download Net-SNMP from http://net-snmp.sourceforge.net

This used to be called ucd-snmp.

=item ii. Install Net-SNMP to include Perl module that comes inside the distribution.

When you run C<./configure>, make sure you add the switch C<--with-perl-modules>

    ./configure --with-perl-modules
    make 
    make install

If you already have net-snmp installed, then go to the source directory and 
in the C<perl> subdirectory and run C<perl Makefile.PL>

    cd /path/to/net-snmp-5.0.x/perl
    perl Makefile.PL
    make
    make install


 ********************************************************************

B<DO NOT> INSTALL the SNMP:: modules off of CPAN or the NET::SNMP module off of CPAN.

 ********************************************************************

Reread the above line.

If you have installed the Net-SNMP RPM from Redhat 8, it doesn't include the Perl modules.
Uninstall it and install a newer version by hand.

=item iii. Run C<snmpconf> and set up your MIB directory. 

(Default F</usr/local/share/snmp/mibs>)

Make sure this new F<snmp.conf> lives in F</usr/local/share/snmp>

=back

=head3 SNMP::Info

This Perl module is an integral part of Netdisco.  It is available
from L<http://snmp-info.sourceforge.net>.   It requires that you have net-snmp installed
first.

SNMP::Info holds all the device-specific code to retrieve data from network devices via SNMP.
A wide variety of Cisco,HP,Bay, and Aironet devices are supported.  You may need to add support
for other devices if they do not follow a standard interface.  This is not too complex.  See 
SNMP::Info for more details.

You have three different options in installing SNMP::Info

=over

=item a. CPAN

    perl -MCPAN -e shell
    install SNMP::Info

=item b. From Source

Download newest version from L<http://snmp-info.sourceforge.net>

    tar xvfz SNMP-Info-0.x.tar.gz 
    cd SNMP-Info-0.x
    perl Makefile.PL
    make install

=item c. From CVS

If you plan to add or change device support in SNMP::Info to customize Netdisco to your devices,
you should install SNMP::Info this way. 

    make snmp

This will create the SNMP/ directory where SNMP::Info will live.   Periodically you should re-run

    make snmp

To update to the most current CVS version.

=back

=head3 MIBs

MIBs are required for F<SNMP::Info>. 

Follow the instructions at L<http://snmp-info.sourceforge.net> for 
what MIBs to install and how to get them.

=head2 7. OUI Database

The Organizationally Unique Identifier (OUI) database allows Netdisco to 
identify the manufacture of a network card using the first 24 bits of a
MAC address.  

The database of OUIs is needed by Netdisco and is available from the IEEE.

If you have C<lynx> installed you can install the OUI database by:

    cd /usr/local/netdisco
    make oui

Or do this by hand:

=over

=item i. Download F<oui.txt> from http://standards.ieee.org/regauth/oui/

=item ii. Run C<netdisco -O>

=back

A note about Make versions.  The Makefile is a GNU Make version file.  In BSD you may
have to type C<gmake>.

=head2 8. GraphViz 

GraphViz is used in the creation of the Network Map.

To Download:

=over

=item i. Download 

For BSD use ports: 

    cd /usr/ports/graphics/graphviz && make install

Others: 

Get the newest version from L<http://www.graphviz.org/pub/graphviz>.
Unarchive and install.

=item ii. True Type Font

Copy a True Type Font file (F<.ttf>) into the Netdisco directory and 
change C<node_font> in F<netdisco.conf> to match.

    cp /path/to/windows/fonts/lucon.ttf /usr/local/netdisco

=item iii. Graph Settings

Review other graph settings in F<netdisco.conf>

=item iv. Check Path

Make sure that neato/twopi is in your path, and/or in the crontab path
that creates the graphs.

    which twopi
    which neato

=item v. Perl Module GraphViz

Make sure the Graphviz Perl module got installed

    perldoc GraphViz

=back

[Optional] If for some reason you choose not to install GraphViz, you still need to install the F<Graph> module
(Perl Modules above).  It is used in topology calculations.

=head2 9. Setup Apache

I<Apache2> -- 

Until mod_perl 2.0 is released as stable, Mason will not run under Apache2.  
Netdisco will not run under Apache2 until that point.

=over

=item Install Apache 1.3.x and mod_perl 1.x and mod_ssl

Netdisco is designed to work in a secure (https) or non-secure
environment.  Due to the security and privacy concerned associated with
this data, using a secure server is recommended.

Below is my method if you haven't installed apache and mod_perl before.
I statically compile mod_perl, and mod_ssl then leave the rest of the 
modules as dynamically loadable objects (DSO).

=over

=item i. Download and Unarchive

Get Apache from L<http://httpd.apache.org>

Get mod_perl from L<http://perl.apache.org>

Get mod_ssl from L<http://www.modssl.org>

Unarchive all three to the same directory, maybe F</usr/local/src>

=item ii. In apache_1.3.x/  

 ./configure 

Sets up the directory scheme.

=item iii. In mod_ssl

For BSD :

=over

=item a. cd /usr/ports/devel/mm && make install

=item b. cd /usr/ports/security/openssl && make install

=item c. Setup mod_ssl

 SSL_BASE=SYSTEM \
 ./configure \
    --with-apache=../apache_1.3.x \
    --disable_rule=SSL_COMPAT

=back

For other OS's 

Follow the instructions in the F<INSTALL> that comes with C<mod_ssl>

 SSL_BASE=/path/to/openssl-0.9.x \
 ./configure \
    --with-apache=../apache_1.3.x \        
    --disable_rule=SSL_COMPAT

=item iv. In mod_perl-1.2x/

 /usr/local/bin/perl Makefile.pl \
        APACHE_SRC=../apache_1.3.x/src \
        EVERYTHING=1 \
        DO_HTTPD=1 \
        USE_APACI=1 \
        PREP_HTTPD=1

 make

=item v. Back in apache_1.3.x/

 ./configure \
        --prefix=/usr/local/apache \
        --enable-module=most \
        --enable-shared=max \
        --activate-module=src/modules/perl/libperl.a \
        --with-perl=/usr/local/bin/perl \
        --enable-module=ssl
 make
 make certificate
 make install

=item vi. Back in mod_perl-1.2x/

 make install

=back

=item httpd.conf

Add the following lines in your C<httpd.conf>. 

Your C<httpd.conf> will live in C</usr/local/apache/conf> if you installed using my method.

=over

=item a. In the Global Section

Add this line B<once> in the end of C<httpd.conf> not in a VirtualHost section.

    Include /usr/local/netdisco/netdisco_apache.conf

=item b. No virtualhosts

If you do not have virtual hosts setup and/or you have a main server, add this line right after the 
first include :

    Include /usr/local/netdisco/netdisco_apache_dir.conf

=item c. In each VirtualHost

If you have Virtual Hosts or are setting up a secure server, put the following
line in each of them that you want Netdisco turned on for:

If you are not using Virtual Hosts, then add this line under the I<netdisco_apache.conf> line.

    Include /usr/local/netdisco/netdisco_apache_dir.conf

=back

=item Mason Data Directory

Set the mason data directory writable to the apache user that does the 
requests.

Assuming C<nobody> is the user that apache requests run this as C<root> :

    mkdir /usr/local/netdisco/mason
    chown nobody.netdisco /usr/local/netdisco/mason

The name of the user is listed in C<httpd.conf> under the C<User> directive. 

=item Start Apache

    /usr/local/apache/apachebin start

=back

Note: Some Linux distributions such as Redhat 6.x install mod_perl as 
a Dynamic Shared Object (DSO).  This is known to be unstable, especially
with Mason.   Compile mod_perl statically using the method listed
above.

=head2 10. Netdisco Configuration

=over

=item netdisco.conf

Modify F<netdisco.conf> to match your site.  

See F<README> for detailed configuration descriptions.

=item netdisco_apache.conf

Change settings on lines:

    session_user_name
    session_password
    session_cookie_domain

=item netdisco.crontab

Change C<!!center_network_device_here!!> to a network device that is well connected to the main
segment by CDP.


=item Add a user in Netdisco

This is a user inside the Netdisco database that will be your Web Admin User

    /usr/local/netdisco/netdisco -u username

Add more users from the web C<Admin Panel> once Netdisco is up and running.

=item Make Documentation

This step is only necessary if you have installed from CVS.

=over 

=item i. Perl Location

Make sure that the C<POD2TEXT>  lines in F<Makefile> point to where your Perl binaries
are installed.

=item ii. Create Docs

 cd /usr/local/netdisco && make doc

=back

=back

=head2 11. Discover a Device in Netdisco

Pick a device that you can access with the command C<snmpwalk>.  
Tell Netdisco to discover that device:

    cd /usr/local/netdisco
    ./netdisco -d devicename

Make sure that this step actually works.  This is a good metric that you have 
now installed Netdisco correctly.  Add the I<-D> flag to get copious debugging info.

=head2 12. Create Network Topology

See F<README> for a description of I<Topology Information>.  

If your network is CDP aware, pick a device that you consider close to the center of the 
network and start an autodiscovery from there:

    cd /usr/local/netdisco
    ./netdisco -r device_name_or_ip_number_here

=head2 13. Test Web Side

First restart Apache so that netdisco will see the changes that you have made
in F<netdisco.conf>.  Note that a I<graceful> restart will not re-read the configuration
file.  A full restart is required.

    /usr/local/apache/bin/apachectl restart

Point a browser to I</netdisco>  on the server you have Netdisco installed on. 
If everything is working you should be able to login with the username and password
you added in Step 10.  You should also be able to access the Admin Panel.

If you have problems, check the F<error_log> of apache for messages.

    tail /usr/local/apache/logs/error_log

=head2 14. Add Cron Jobs

Once you're sure Netdisco is setup correctly add the Cron jobs listed in
F<netdisco.crontab>.

    su - -c "cron -u netdisco /usr/local/netdisco/netdisco.crontab"

You may want to fine-tune these jobs to your network.

=head2 15. Start Admin Daemon

The admin deaemon performs administration jobs that are requested from the
web front-end.  See F<README> for a description of the admin daemon.  

    su - netdisco -c "/usr/local/netdisco/netdisco -p start"

=cut
