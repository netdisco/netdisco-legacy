<h3>IP Search</h3>
% $m->comp('SELF:show_age') if $cmd eq 'age';
<FORM ACTION="<%$r->uri%>" METHOD="GET">
<INPUT TYPE="hidden" NAME="cmd" VALUE="age">
<TABLE CLASS="box" BORDER=0>
<TR>
    <TD>IPs not used in :</TD>
    <TD>
        <SELECT NAME="age_val">
% for (1..12) {
            <OPTION VALUE="<%$_%>"<%$age_val eq $_ ? ' SELECTED' : ''%>><%$_%>
% }
        </SELECT>
        <SELECT NAME="age_mul">
% for (qw/days months years/) {
            <OPTION VALUE="<%$_%>"<%$age_mul eq $_ ? ' SELECTED' : ''%>><%$_%>
% }
        </SELECT>
    <TD>Sort By :</TD>
    <TD><SELECT NAME="sort" SIZE=1>
%       foreach my $s (sort @sorts){
            <OPTION VALUE="<%$s%>" <% $sort eq $s ? 'SELECTED' : ''%>><%$s%>
%       } 
    </TD>
</TR>
<TR>
    <TD>Limit to Subnet :</TD>
    <TD><INPUT TYPE="text" SIZE=20 NAME="subnet" VALUE="<%$subnet|h%>" TITLE="CIDR Format : 192.168.0.0/24">
        <BR><font size=-2>(CIDR Format : <tt>192.168.0.0/24</tt>)</font>
    </TD>
    <TD>Limit :</TD>
    <TD><SELECT NAME="max" SIZE=1>
% for (qw/10 50 100 200 500 1000 5000 100000/){
        <OPTION VALUE="<%$_%>"<%$max eq $_ ? ' SELECTED' : ''%>><%$_%>
%}
    </TD>
</TR>
<TR>
    <TD COLSPAN=4>
        <INPUT TYPE="submit" VALUE="Find IPs">
    </TD>
</TABLE>
</FORM>
Finds IP Addresses used by nodes.
<%args>
$subnet  => ''
$sort    => 'Age'
$age_val => 2
$age_mul => 'months'
$cmd     => ''
$max     => 200
</%args>
<%shared>
my @sorts = qw/IP Age/;
my ($ips,$arg_sort,$odd,$arg_max);
</%shared>
<%init>

$arg_sort = $sort; $arg_max = $max;
if ($cmd eq 'age'){
    $age_val = 2 unless $age_val =~ m/^\d+$/;
    $age_mul =~ s/[^a-z ]+//g;
    my $bool    = '>=';
    my $archive =0;
    my $where =  {'age(now(),time_last)' => \\"$bool interval '$age_val $age_mul'"};
    $where->{active} = \'true' unless ($archive);
    if ($subnet){
        my $safenet = dbh_quote($subnet);
        $where->{ip} = \\"<< $safenet"  if $subnet;
    } 
    $ips = sql_rows('node_ip',['age(now(),time_last) as age','extract(epoch from time_first) as time_first',
                               'extract(epoch from time_last) as time_last','ip','active'],
                    $where);
}
</%init>
<%method show_age>
<H4>Results</H4>
% unless (scalar @$ips) {
No Results Found.
% return; }
<TABLE WIDTH="100%" BORDER=0 CELLSPACING=0>
    <TR>
        <TH>Node</TH>
        <TH>Last Used</TH>
        <TH>First<BR>Discovered</TH>
    </TR>
<%perl>
my @rows;
if ($arg_sort eq 'Age'){
    @rows = sort { $a->{time_last} <=> $b->{time_last} } @$ips;
} else {
    @rows = sort sort_ip @$ips;
}

# Truncate the list if too long (too many results)
if (scalar @rows > $arg_max) {
    splice(@rows,$arg_max);
    $m->out("Found ".scalar(@$ips) ." matching IPs.  Only showing $arg_max.<BR>\n");
}
foreach my $row (@rows){
    my $ip = $row->{ip};
    my $age = $m->comp('device_inv.html:.trim_age', age => $row->{age});
    my $time_first = scalar(localtime($row->{time_first}));
</%perl>
<TR CLASS="match-<%++$odd%2%>">
    <TD><A HREF="node.html?node=<%$ip|u%>"><%$ip%></a></TD><TD><%$age%></TD><TD><%$time_first%></TD>
</TR>
%}
</TABLE>
<% scalar @rows %> IPs Shown.
</%method>
<%method title>
- IP Search \
</%method>
%# $Id$
%# vim:syntax=mason
