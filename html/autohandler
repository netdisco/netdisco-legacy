<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<TITLE>n e t  d i s c o <& SELF:title &> </TITLE>
<LINK REL="stylesheet" HREF="<%$path%>/netdisco.css" TYPE="text/css" MEDIA="screen">
<& SELF:html_head &>
</HEAD>
<BODY>
    <div class="topbar">
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N&nbsp;e&nbsp;t&nbsp;&nbsp;d&nbsp;i&nbsp;s&nbsp;c&nbsp;o
    </div>
    <div class="sidebar">
        <& sidebar.html &>
    </div>
    <div class="content">
%       $m->call_next;
    </div>
    <div class="botbar">
        Netdisco <%$netdisco::VERSION%> 
    </div>
</BODY>
</HTML>
<%init>
my $cfgupdate = netdisco::updateconfig();
my $session_timeout = $netdisco::CONFIG{websession} || 60; # min

my $ok = 0;
# Authentication - Logged in and not expired?
if (defined $m->session->{_logged_in} and $m->session->{_logged_in} ){
    if (defined $m->session->{start}) {
        my $age = time - $m->session->{start};
        $ok = $age < 60*$session_timeout;
    } 
}

# Redirect to Login page unless we're ok
my $path   = $netdisco::CONFIG{webpath};
my $target = $m->fetch_next->name;
unless ($ok or $target =~ /(apache_)?login.html/) {
    my $target_uri = $r->uri;
    my $target_args = $r->args;
    my $url = $target_uri;
    $url .= "?$target_args" if (defined $target_args and length($target_args));
    HTML::Mason::Escapes::url_escape(\$url);
    my $page = $netdisco::CONFIG{apache_auth} ? "apache_login" : "login";
    $m->redirect("$path/$page.html?done=$url");
} 

# For Logging, tell apache what user is in:
$r->connection->user($m->session->{user}) if ($ok && defined($m->session->{user}));
</%init>
<%method html_head>
\
</%method>
<%method title>
\
</%method>
%# $Id$
%# vim:syntax=mason
