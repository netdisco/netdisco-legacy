<& SELF:matches &>

<h1 class="pagehead">Port Search</h1>
<FORM ACTION="<%$r->uri%>" METHOD="get">
<TABLE CLASS="port-search">
<TR>
    <TD>Port name or description:</TD>
    <TD><INPUT TYPE="text" name="port" maxlength=255 size=30 VALUE="<%$port || $m->session->{_s_term}  |h%>">
        <BR><span class="smaller"><B>*</B> and <B>?</B> can be used as a wildcard
    </TD>
</TR>
<TR>
    <TD>&nbsp;</TD>
    <TD>
        <INPUT TYPE="submit" CLASS="navbutton" Value="Search" class="navbutton">
        <A HREF="<%$r->uri%>" class="navbutton">Clear</A>
    </TD>
</TR>
</TABLE>
</FORM>

<%args>
$port      => ''
</%args>
<%shared>
my $matches = [];
my $domain = $netdisco::CONFIG{domain};
my @cols = ();
my $arg_port;
my $count = 0; 
my $ran_query = 0;

my %MatchMAP = ('port'    => 'Switch Port',
                'swport'  => 'Switch Port',
               );
</%shared>
<%init>

# Pass the form argument to the global for <%methods>
$arg_port = $port;

# ----------------- Node Search -------------------------
if ($port){

    $m->flush_buffer;

    $port =~ s/^\s+//;
    $port =~ s/\s+$//;

    # Save search terms to session, change topbar
    $m->session->{_s_term} = $port;
    $m->session->{_s_type} = 'port';
    $matches = sql_rows('device d join device_port dp on d.ip = dp.ip', 
        ['d.location', 'dp.ip', 'dp.port', 'dp.name'], 
        {'dp.name' => &sql_match($port, 0)}
    );

    $ran_query++;
}


</%init>
%#
%# matches() - Outputs results
%#
<%method matches>
% return unless $ran_query;
<h1 class="pagehead">Search Results</H1>
%unless (scalar @$matches){
No results found. Try using wildcards.
% return; }
<TABLE class="port-search">
<TR>
    <TH>Device IP</TH>
    <TH>Port</TH>
    <TH>Name</TH>
    <TH>Location</TH>
</TR>
% foreach my $row (@$matches){
<TR>
    <TD CLASS="match-<%$count%2%>"> <A HREF=device.html?ip=<%$row->{ip}%>&port=<%$row->{port}%>> <%$row->{ip}%> </A> </TD>
    <TD CLASS="match-<%$count%2%>"> <A HREF=device.html?ip=<%$row->{ip}%>&port=<%$row->{port}%>> [<%$row->{port}%>] </A> </TD>
    <TD CLASS="match-<%$count%2%>"> <%$row->{name}%> </TD>
    <TD CLASS="match-<%$count%2%>"> <%$row->{location}%> </TD>
</TR>
%   $count++;
% }


</TABLE>
Matched <% $count %> nodes.
</%method>
%#
%# FILTER: highlight search term
%#
<%filter>
return $_ unless $arg_port;
my $open = '<SPAN CLASS="highlight">';
my $close = '</SPAN>';
my $search = $arg_port;
# Quote all special chars
$search =~ s/(\W)/\\$1/g;
# But turn back on ? and *
$search =~ s/\\\*/[^<]*/g;
$search =~ s/\\\?/[^<]/g;
# find things after > but before < to make sure we don't mess w/
#   the HTML.
s{(>[^<]*)($search)([^<]*<)} {$1$open$2$close$3}ig;
</%filter>
%#
%# $Id$
%# vim:syntax=mason
